<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dynamicdl.dynamicdl &mdash; DynamicDL 0.1.1-alpha documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=e30984f2"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            DynamicDL
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">DynamicData Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dynamicdl.html">DynamicDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data.html">Data Items</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parsing.html">Parsing Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../processing.html">File Processing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">DynamicDL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dynamicdl.dynamicdl</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dynamicdl.dynamicdl</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">hashlib</span> <span class="kn">import</span> <span class="n">md5</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">jsonpickle</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">isna</span>
<span class="kn">from</span> <span class="nn">pandas.core.series</span> <span class="kn">import</span> <span class="n">Series</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">FloatTensor</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torchvision.utils</span> <span class="kn">import</span> <span class="n">draw_bounding_boxes</span>
<span class="kn">import</span> <span class="nn">torchvision.transforms.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span> <span class="k">as</span> <span class="n">T</span>
<span class="kn">from</span> <span class="nn">PIL.Image</span> <span class="kn">import</span> <span class="nb">open</span> <span class="k">as</span> <span class="n">open_image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Self</span>

<span class="kn">from</span> <span class="nn">._utils</span> <span class="kn">import</span> <span class="n">next_avail_id</span><span class="p">,</span> <span class="n">union</span><span class="p">,</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">._warnings</span> <span class="kn">import</span> <span class="n">Warnings</span>
<span class="kn">from</span> <span class="nn">._main._engine</span> <span class="kn">import</span> <span class="n">populate_data</span>
<span class="kn">from</span> <span class="nn">._main._transforms</span> <span class="kn">import</span> <span class="n">Transforms</span>
<span class="kn">from</span> <span class="nn">._main._collate</span> <span class="kn">import</span> <span class="n">_collate</span>
<span class="kn">from</span> <span class="nn">.dynamicds</span> <span class="kn">import</span> <span class="n">DynamicDS</span>

<div class="viewcode-block" id="DynamicData">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData">[docs]</a>
<span class="k">class</span> <span class="nc">DynamicData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Main dataset class. Accepts root directory path and dictionary form of the structure.</span>
<span class="sd">    DynamicDL expands a generic dataset form and interprets it through a series of recursive</span>
<span class="sd">    hierarchical inheritances, to flatten the dataset into a list of entries fit for image</span>
<span class="sd">    processing.</span>
<span class="sd">    </span>
<span class="sd">    :param root: The root directory to access the dataset.</span>
<span class="sd">    :type root: str</span>
<span class="sd">    :param form: The form of the dataset. See documentation for further details on valid forms.</span>
<span class="sd">    :type form: dict</span>
<span class="sd">    :param bbox_scale_option: Choose from either `auto`, `zeroone`, or `full` scale options to</span>
<span class="sd">        define, or leave empty for automatic. `zeroone` assumes detection coordinates to be</span>
<span class="sd">        interpreted on a 0-1 scale as ratios dependent on image size. `full` leaves coordinates</span>
<span class="sd">        as is. `auto` for auto-detection. Default: `auto`</span>
<span class="sd">    :type bbox_scale_option: str</span>
<span class="sd">    :param seg_scale_option: Choose from either `auto`, `zeroone`, or `full` scale options to</span>
<span class="sd">        define, or leave empty for automatic. `zeroone` assumes segmentation coordinates to be</span>
<span class="sd">        interpreted on a 0-1 scale as ratios dependent on image size. `full` leaves coordinates</span>
<span class="sd">        as is. `auto` for auto-detection. Default: `auto`</span>
<span class="sd">    :type seg_scale_option: str</span>
<span class="sd">    :param get_md5_hashes: When set to True, create a new column which finds md5 hashes for each</span>
<span class="sd">        image available, and makes sure there are no duplicates. Default: `False`</span>
<span class="sd">    :type get_md5_hashes: bool</span>
<span class="sd">    :param purge_duplicates: When set to True, remove all duplicate image entries. Duplicate images</span>
<span class="sd">        are defined by having the same md5 hash, so this has no effect when `get_md5_hashes` is </span>
<span class="sd">        `False`. When set to `False`, do not purge duplicates. Default: `None`</span>
<span class="sd">    :type purge_duplicates: Optional[bool]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">_modes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;MODES&#39;</span><span class="p">]</span>

    <span class="n">_BBOX_MODES</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;BBOX_MODES&#39;</span><span class="p">]</span>
    <span class="n">_BBOX_COLS</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;BBOX_COLS&#39;</span><span class="p">]</span>

    <span class="n">_scale_options</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;zeroone&#39;</span><span class="p">,</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">form</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">bbox_scale_option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">seg_scale_option</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
        <span class="n">get_md5_hashes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">purge_duplicates</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="n">form</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seg_class_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_seg_class</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox_class_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_bbox_class</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_class</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_md5_hashes</span> <span class="o">=</span> <span class="n">get_md5_hashes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purge_duplicates</span> <span class="o">=</span> <span class="n">purge_duplicates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span> <span class="o">=</span> <span class="n">bbox_scale_option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span> <span class="o">=</span> <span class="n">seg_scale_option</span>

<div class="viewcode-block" id="DynamicData.parse">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.parse">[docs]</a>
    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Must be called to instantiate the data in the dataset instance. Performs the recursive</span>
<span class="sd">        populate_data algorithm and creates the dataframe, and then cleans up the data.</span>
<span class="sd">        </span>
<span class="sd">        :param override: Whether to overwrite existing data if it has already been parsed and</span>
<span class="sd">            cleaned. Default: `False`</span>
<span class="sd">        :type override: bool</span>
<span class="sd">        :param verbose: Whether to show more details about the merging process. May have an impact</span>
<span class="sd">            on runtime. Default: `False`</span>
<span class="sd">        :type verbose: bool</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Parsing data...&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">override</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;already_parsed&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">populate_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DynamicData] Parsed! (</span><span class="si">{</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">s)&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DynamicData] Cleaned! (</span><span class="si">{</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">s)&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_statistics</span><span class="p">())</span></div>


    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Run cleanup and sanity checks on all data. Assigns IDs to name-only values.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Cleaning up data...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;ABSOLUTE_FILE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;no_images&#39;</span><span class="p">)</span>

        <span class="c1"># sort by image id first to prevent randomness</span>
        <span class="k">if</span> <span class="s1">&#39;IMAGE_ID&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;IMAGE_ID&#39;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;IMAGE_NAME&#39;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;IMAGE_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span>

        <span class="c1"># get image sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_img_sizes</span><span class="p">()</span>

        <span class="c1"># get md5 hashes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_md5_hashes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_md5_hashes</span><span class="p">()</span>

        <span class="c1"># convert bounding boxes into proper format and store under &#39;BOX&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_bbox</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;BOX&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_box_scale</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_box_scale</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;POLYGON&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_seg_scale</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_convert_seg_scale</span><span class="p">()</span>

        <span class="c1"># assign ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_ids</span><span class="p">(</span><span class="s1">&#39;CLASS&#39;</span><span class="p">,</span> <span class="n">redundant</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_ids</span><span class="p">(</span><span class="s1">&#39;SEG_CLASS&#39;</span><span class="p">,</span> <span class="n">redundant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process_ids</span><span class="p">(</span><span class="s1">&#39;BBOX_CLASS&#39;</span><span class="p">,</span> <span class="n">redundant</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># check available columns to determine mode availability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span> <span class="o">=</span> <span class="n">DynamicData</span><span class="o">.</span><span class="n">_get_modes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">)</span>

        <span class="c1"># cleanup image sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup_image_sets</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_modes</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode</span> <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">DynamicData</span><span class="o">.</span><span class="n">_modes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">subset</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">modes</span>

    <span class="k">def</span> <span class="nf">_get_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;[DynamicData] Dataset statistics:</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;       | Available modes: </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;       | Images: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">DynamicData</span><span class="o">.</span><span class="n">_modes</span><span class="p">[</span><span class="n">mode</span><span class="p">])]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">])</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;       | Complete entries for </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;detection&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;       | Bounding box scaling option: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;segmentation_poly&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span> <span class="ow">or</span> 
            <span class="s1">&#39;segmentation_mask&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;       | Segmentation object scaling option: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">redundant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
                <span class="n">call</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_assign_ids</span><span class="p">,</span> <span class="n">redundant</span><span class="o">=</span><span class="n">redundant</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">call</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_validate_ids</span><span class="p">,</span> <span class="n">redundant</span><span class="o">=</span><span class="n">redundant</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">call</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">_to_idx&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;idx_to_</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;idx_to_</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">]</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span><span class="p">})</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">_to_idx&#39;</span><span class="p">,</span>
                    <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">i</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">]</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">item</span><span class="p">})</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;idx_to_</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)[</span><span class="n">x</span><span class="p">],</span> <span class="n">i</span><span class="p">))</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_patch_ids</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">_to_idx&#39;</span><span class="p">),</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;idx_to_</span><span class="si">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
            <span class="n">redundant</span><span class="o">=</span><span class="n">redundant</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_img_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;IMAGE_DIM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">open_image</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                                       <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;ABSOLUTE_FILE&#39;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_get_md5_hashes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hashes</span> <span class="o">=</span> <span class="p">[</span><span class="n">md5</span><span class="p">(</span><span class="n">open_image</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span>
                  <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;ABSOLUTE_FILE&#39;</span><span class="p">],</span><span class="n">desc</span><span class="o">=</span><span class="s1">&#39;[DynamicData] Calculating md5 hashes&#39;</span><span class="p">)]</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">md5hash</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hashes</span><span class="p">):</span>
            <span class="n">counter</span><span class="p">[</span><span class="n">md5hash</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">md5hash</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">duplicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">locs</span> <span class="k">for</span> <span class="n">locs</span> <span class="ow">in</span> <span class="n">counter</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">locs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;MD5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hashes</span>
        <span class="k">if</span> <span class="n">duplicates</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_duplicates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">strmsg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">locs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">duplicates</span><span class="p">):</span>
                    <span class="n">locstr</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;IMAGE_NAME&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">loc</span><span class="p">]</span> <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locs</span><span class="p">])</span>
                    <span class="n">strmsg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">locstr</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;duplicate_images&#39;</span><span class="p">,</span> <span class="n">duplicates</span><span class="o">=</span><span class="n">duplicates</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">purge_duplicates</span><span class="p">:</span>
                <span class="n">dupes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">locs</span> <span class="ow">in</span> <span class="n">duplicates</span><span class="p">:</span>
                    <span class="n">dupes</span> <span class="o">+=</span> <span class="n">locs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">dupes</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_box_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">boxes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;BOX&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">coord</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">box</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">coord</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">box</span><span class="p">):</span>
                    <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;invalid_scale_data_bbox&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Detected full size bounding box scale option&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Detected [0, 1] bounding box scale option to be converted to full &#39;</span>
                  <span class="s1">&#39;size&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span> <span class="o">=</span> <span class="s1">&#39;zeroone&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DynamicData</span><span class="o">.</span><span class="n">_scale_options</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;invalid_scale&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_seg_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">shapes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;POLYGON&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shapes</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">shape</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">coord</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Detected full size segmentation scale option&#39;</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">coord</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">shapes</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">):</span>
                    <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;invalid_scale_data&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Detected [0, 1] segmentation scale option to be converted to full &#39;</span>
                  <span class="s1">&#39;size&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span> <span class="o">=</span> <span class="s1">&#39;zeroone&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DynamicData</span><span class="o">.</span><span class="n">_scale_options</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;invalid_scale&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_convert_box_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span> <span class="o">==</span> <span class="s1">&#39;zeroone&#39;</span><span class="p">:</span>
            <span class="n">boxes_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;BOX&#39;</span><span class="p">,</span> <span class="s1">&#39;IMAGE_DIM&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">isna</span><span class="p">()):</span>
                    <span class="n">boxes_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="k">continue</span>
                <span class="n">apply_resize</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_DIM&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_DIM&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_DIM&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_DIM&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">boxes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">apply_resize</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;BOX&#39;</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;BOX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes_list</span>

    <span class="k">def</span> <span class="nf">_convert_seg_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span> <span class="o">==</span> <span class="s1">&#39;zeroone&#39;</span><span class="p">:</span>
            <span class="n">shapes_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[[</span><span class="s1">&#39;POLYGON&#39;</span><span class="p">,</span> <span class="s1">&#39;IMAGE_DIM&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">isna</span><span class="p">()):</span>
                    <span class="n">shapes_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="k">continue</span>
                <span class="n">apply_resize</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_DIM&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_DIM&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">shapes_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">apply_resize</span><span class="p">,</span> <span class="n">shape</span><span class="p">))</span> <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;POLYGON&#39;</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;POLYGON&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shapes_list</span>

    <span class="k">def</span> <span class="nf">_validate_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">redundant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name_to_idx</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;Check whether a value is corrupted/mismatch, and update dict accordingly&#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">isna</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isna</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
                <span class="k">return</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">name_to_idx</span> <span class="ow">and</span> <span class="n">name_to_idx</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;invalid_id_map&#39;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                    <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
                    <span class="n">expect</span><span class="o">=</span><span class="n">name_to_idx</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_to_idx</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

        <span class="n">name_to_idx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isna</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isna</span><span class="p">(</span><span class="n">vals</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">redundant</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
                    <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;row_mismatch&#39;</span><span class="p">,</span>
                        <span class="n">name1</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">,</span>
                        <span class="n">name2</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">,</span>
                        <span class="n">len1</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">),</span>
                        <span class="n">len2</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
                    <span class="n">check</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">name_to_idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">name_to_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name_to_idx</span><span class="p">,</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">name_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">_patch_ids</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">name_to_idx</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">idx_to_name</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">redundant</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Patch nan values of ids/vals accordingly.&#39;&#39;&#39;</span>
        <span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">redundant</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">isna</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isna</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
                    <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found missing </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> id/name at row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">isna</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_to_idx</span><span class="p">[</span><span class="n">vals</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isna</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_to_name</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ctr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DynamicData] Patched </span><span class="si">{</span><span class="n">ctr</span><span class="si">}</span><span class="s1"> id/name pairs for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Use parse() with verbose=True to see all invalid entries.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">id_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name_vals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">ctr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found missing </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> id/name at row </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">id_vals</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">name_vals</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">id_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">name_to_idx</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">vals</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">id_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="n">name_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">idx_to_name</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">ids</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">id_vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name_vals</span>
        <span class="k">if</span> <span class="n">ctr</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DynamicData] Patched </span><span class="si">{</span><span class="n">ctr</span><span class="si">}</span><span class="s1"> id/name pairs for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Use parse() with verbose=True to see all invalid entries.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_assign_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">redundant</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> \
            <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="n">sets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">default_value</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">redundant</span> <span class="k">else</span> <span class="s1">&#39;default&#39;</span>
        <span class="k">if</span> <span class="n">default</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">default_value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">redundant</span><span class="p">:</span>
                <span class="n">sets</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sets</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">name_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sets</span><span class="p">)}</span>
        <span class="n">idx_to_name</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">name_to_idx</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">redundant</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">name_to_idx</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">x</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="n">name_to_idx</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">name_to_idx</span><span class="p">,</span> <span class="n">idx_to_name</span>

    <span class="k">def</span> <span class="nf">_convert_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cols</span><span class="p">,</span> <span class="n">funcs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">colset</span><span class="p">,</span> <span class="n">key_cols</span><span class="p">,</span> <span class="n">key_funcs</span> <span class="ow">in</span> <span class="n">DynamicData</span><span class="o">.</span><span class="n">_BBOX_MODES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">colset</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">cols</span><span class="p">,</span> <span class="n">funcs</span> <span class="o">=</span> <span class="n">key_cols</span><span class="p">,</span> <span class="n">key_funcs</span>
        <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">funcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">DynamicData</span><span class="o">.</span><span class="n">_BBOX_COLS</span><span class="p">):</span>
                <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;incomplete_bbox&#39;</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="n">DynamicData</span><span class="o">.</span><span class="n">_BBOX_COLS</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">execute_checks</span><span class="p">(</span><span class="n">row</span><span class="p">:</span> <span class="n">Series</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="nb">float</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]):</span>
                    <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s1">&#39;row_mismatch&#39;</span><span class="p">,</span>
                        <span class="n">name1</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">name2</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">len1</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">x</span><span class="p">]),</span>
                        <span class="n">len2</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">execute_checks</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
                <span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]):</span>
                    <span class="n">box</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]((</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)),</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]((</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">)),</span>
                                <span class="n">funcs</span><span class="p">[</span><span class="mi">2</span><span class="p">]((</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)),</span> <span class="n">funcs</span><span class="p">[</span><span class="mi">3</span><span class="p">]((</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">))))</span>
                <span class="n">boxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;BOX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">boxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">DynamicData</span><span class="o">.</span><span class="n">_BBOX_COLS</span><span class="o">.</span><span class="n">difference</span><span class="p">({</span><span class="s1">&#39;BBOX_CLASS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;BBOX_CLASS_NAME&#39;</span><span class="p">}),</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cleanup_image_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;IMAGE_SET_NAME&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_ids</span><span class="p">(</span><span class="s1">&#39;IMAGE_SET&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">redundant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">elif</span> <span class="s1">&#39;IMAGE_SET_ID&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;default&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_ID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_ID&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">_cleanup_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CLASS_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;IMAGE_ID&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;Int64&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="DynamicData.get_transforms">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.get_transforms">[docs]</a>
    <span class="k">def</span> <span class="nf">get_transforms</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inference&#39;</span><span class="p">,</span>
        <span class="n">calculate_stats</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">mean</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span>
        <span class="n">std</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">),</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">remove_invalid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">resize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Retrieve the default standard image/label transforms for specified mode.</span>
<span class="sd">        </span>
<span class="sd">        :param mode: Choose a mode out of available modes for the transforms. Each mode has</span>
<span class="sd">            slightly altered standard transforms.</span>
<span class="sd">        :type mode: str</span>
<span class="sd">        :param calculate_stats: When set to True, calculate the statistics for the entire</span>
<span class="sd">            dataset, overriding default mean/std kwarg (defaults from ImageNet). Use this feature</span>
<span class="sd">            when dataset mean/std is unknown and differs significantly from ImageNet. Default: True.</span>
<span class="sd">        :type calculate_stats: bool</span>
<span class="sd">        :param mean: Default mean statistics for the dataset. Has no effect when</span>
<span class="sd">            `calculate_stats = True`. Default: ImageNet values.</span>
<span class="sd">        :type mean: Tuple[float, ...]</span>
<span class="sd">        :param std: Default mean statistics for the dataset. Has no effect when</span>
<span class="sd">            `calculate_stats = True`. Default: ImageNet values.</span>
<span class="sd">        :type std: Tuple[float, ...]</span>
<span class="sd">        :param normalize: When set to True, normalize the dataset according to some</span>
<span class="sd">            mean/std values, either from calculated stats or ImageNet default. This statement is</span>
<span class="sd">            overriden when `calculate_stats` is set to True. Default: True.</span>
<span class="sd">        :type normalize: bool</span>
<span class="sd">        :param remove_invalid: Remove invalid entries when calculating the statistics, assuming</span>
<span class="sd">            `calculate_stats` is set to `True`. If `calculate_stats` is `False`, this value has no</span>
<span class="sd">            effect. Default: `True`.</span>
<span class="sd">        :type remove_invalid: bool</span>
<span class="sd">        :param resize: Resize to specific tuple dimensions before calculating statistics, only when</span>
<span class="sd">            `calculate_stats` is set to True, just like `remove_invalid`. Default: `None`.</span>
<span class="sd">        :type resize: Optional[Tuple[int, ...]]</span>
<span class="sd">        :return: A tuple of two callable transforms, the first being the standard image transform</span>
<span class="sd">            and the latter being the standard target transform.</span>
<span class="sd">        :rtype: Tuple[Optional[Callable], ...]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">calculate_stats</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Transforms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="n">resize</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span> <span class="ow">or</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;inference&#39;</span><span class="p">,</span> <span class="s1">&#39;diffusion&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataloader</span><span class="p">(</span>
            <span class="n">mode</span><span class="p">,</span>
            <span class="n">remove_invalid</span><span class="o">=</span><span class="n">remove_invalid</span><span class="p">,</span>
            <span class="n">image_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">preset_transform</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">transforms</span><span class="o">=</span><span class="n">Transforms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="n">resize</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">resize</span><span class="o">=</span><span class="n">resize</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">mean</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">std</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Calculating stats&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">mean</span> <span class="o">+=</span> <span class="n">image</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">std</span> <span class="o">+=</span> <span class="n">image</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">batch_samples</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">images</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_samples</span><span class="p">,</span> <span class="n">images</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">mean</span> <span class="o">+=</span> <span class="n">images</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">std</span> <span class="o">+=</span> <span class="n">images</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">mean</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DynamicData] Got mean </span><span class="si">{</span><span class="n">mean</span><span class="si">}</span><span class="s2"> and std </span><span class="si">{</span><span class="n">std</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Transforms</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">resize</span><span class="o">=</span><span class="n">resize</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="DynamicData.get_dataset">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.get_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inference&#39;</span><span class="p">,</span>
        <span class="n">remove_invalid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">store_dim</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preset_transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">calculate_stats</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">mean</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span>
        <span class="n">std</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">),</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">image_set</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">target_transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalize_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DynamicDS&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Retrieve the PyTorch dataset (`torch.utils.data.Dataset`) of a specific mode and image set.</span>
<span class="sd">        </span>
<span class="sd">        :param mode: The mode of training to select. See available modes with `available_modes`.</span>
<span class="sd">        :type mode: str</span>
<span class="sd">        :param remove_invalid: If set to True, deletes any NaN/corrupt items in the image set</span>
<span class="sd">            pertaining to the relevant mode. In the False case, either NaN values are substituted</span>
<span class="sd">            with empty values or an error is thrown, depending on the mode selected.</span>
<span class="sd">        :type remove_invalid: bool</span>
<span class="sd">        :param store_dim: If set to True, the labels in the dataset will return a dict with two</span>
<span class="sd">            keys. `label` contains the standard PyTorch labels and `dim` contains the image&#39;s</span>
<span class="sd">            former dimensions.</span>
<span class="sd">        :type store_dim: bool</span>
<span class="sd">        :param preset_transform: Whether to use default preset transforms. Consists of normalization</span>
<span class="sd">            with either calculated mean of the dataset about to be used or standard ImageNet</span>
<span class="sd">            statistics depending on `calculate_stats`. Default: `True`</span>
<span class="sd">        :type preset_transform: bool</span>
<span class="sd">        :param calculate_stats: Whether to calculate mean and std for this dataset to be used in</span>
<span class="sd">            normalization transforms. If False, uses ImageNet default weights. Only has effect</span>
<span class="sd">            when `preset_transform` is set to `True`. Default: `True`</span>
<span class="sd">        :type calculate_stats: bool</span>
<span class="sd">        :param mean: Default mean statistics for the dataset. Has no effect when</span>
<span class="sd">            `calculate_stats = True`. Default: ImageNet values.</span>
<span class="sd">        :type mean: Tuple[float, ...]</span>
<span class="sd">        :param std: Default mean statistics for the dataset. Has no effect when</span>
<span class="sd">            `calculate_stats = True`. Default: ImageNet values.</span>
<span class="sd">        :type std: Tuple[float, ...]</span>
<span class="sd">        :param normalize: When set to `True`, normalize the dataset according to some mean/std</span>
<span class="sd">            values, either from calculated stats or ImageNet default. This statement is overriden</span>
<span class="sd">            when `calculate_stats` is set to `True`. Default: `True`.</span>
<span class="sd">        :type normalize: bool</span>
<span class="sd">        :param image_set: The image set to pull from. Default: all images.</span>
<span class="sd">        :type image_set: Optional[str]</span>
<span class="sd">        :param transform: The transform operation to apply to the images.</span>
<span class="sd">        :type transform: Optional[Callable]</span>
<span class="sd">        :param target_transform: The transform operation to apply to the labels.</span>
<span class="sd">        :type target_transform: Optional[Callable]</span>
<span class="sd">        :param transforms: Tuple in the format `(transform, target_transform)`. Obtain default</span>
<span class="sd">            transforms from `DynamicData.get_transforms()`, or supply your own.</span>
<span class="sd">        :type transforms: Optional[Tuple[Optional[Callable], ...]]</span>
<span class="sd">        :param resize: If provided, resize all images to exact `(width, height)` configuration.</span>
<span class="sd">        :type resize: Optional[Tuple[int, ...]]</span>
<span class="sd">        :param normalize_to: If provided, normalize bounding box/segmentation coordinates to a</span>
<span class="sd">            specific configuration. Options: &#39;zeroone&#39;, &#39;full&#39;</span>
<span class="sd">        :type normalize_to: Optional[str]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;mode_unavailable&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">transforms</span><span class="p">:</span>
            <span class="n">transform</span><span class="p">,</span> <span class="n">target_transform</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="k">elif</span> <span class="n">preset_transform</span><span class="p">:</span>
            <span class="n">transform</span><span class="p">,</span> <span class="n">target_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transforms</span><span class="p">(</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">remove_invalid</span><span class="o">=</span><span class="n">remove_invalid</span><span class="p">,</span>
                <span class="n">resize</span><span class="o">=</span><span class="n">resize</span><span class="p">,</span>
                <span class="n">calculate_stats</span><span class="o">=</span><span class="n">calculate_stats</span><span class="p">,</span>
                <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span>
                <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
                <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span>
            <span class="p">)</span>

        <span class="n">imgset_mode</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;id&#39;</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[[</span><span class="n">image_set</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;IMAGE_SET_</span><span class="si">{</span><span class="n">imgset_mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]]]</span>
        <span class="k">if</span> <span class="n">image_set</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;image_set_missing&#39;</span><span class="p">,</span> <span class="n">imgset_name</span><span class="o">=</span><span class="n">imgset_mode</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="n">image_set</span><span class="p">)</span>
        <span class="n">normalization</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">DynamicData</span><span class="o">.</span><span class="n">_modes</span><span class="p">[</span><span class="n">mode</span><span class="p">])]</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;classification&#39;</span><span class="p">:</span>
            <span class="n">id_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_class</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;detection&#39;</span><span class="p">:</span>
            <span class="n">normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span>
            <span class="n">id_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_bbox_class</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;segmentation_mask&#39;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;segmentation_poly&#39;</span><span class="p">:</span>
            <span class="n">normalization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span>
            <span class="n">id_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_seg_class</span><span class="p">)}</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;inference&#39;</span> <span class="ow">or</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;diffusion&#39;</span><span class="p">:</span>
            <span class="n">id_mapping</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">remove_invalid</span><span class="p">:</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;detection&#39;</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
                <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;BOX&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)]</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DynamicData] Removed </span><span class="si">{</span><span class="n">start</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">end</span><span class="si">}</span><span class="s1"> empty entries from data.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">replace_nan</span> <span class="o">=</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">([]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="p">))</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;detection&#39;</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BBOX_CLASS_ID&#39;</span><span class="p">]</span> <span class="c1"># BOX already accounted for in bbox creation</span>
            <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;segmentation_poly&#39;</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;POLYGON&#39;</span><span class="p">,</span> <span class="s1">&#39;SEG_CLASS_ID&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">replace_nan</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">isna</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;nan_exists&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;image_set_empty&#39;</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="n">image_set</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DynamicDS</span><span class="p">(</span>
            <span class="n">dataframe</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
            <span class="n">mode</span><span class="p">,</span>
            <span class="n">id_mapping</span><span class="o">=</span><span class="n">id_mapping</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
            <span class="n">target_transform</span><span class="o">=</span><span class="n">target_transform</span><span class="p">,</span>
            <span class="n">resize</span><span class="o">=</span><span class="n">resize</span><span class="p">,</span>
            <span class="n">store_dim</span><span class="o">=</span><span class="n">store_dim</span><span class="p">,</span>
            <span class="n">normalize_to</span><span class="o">=</span><span class="n">normalize_to</span><span class="p">,</span>
            <span class="n">normalization</span><span class="o">=</span><span class="n">normalization</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DynamicData.get_dataloader">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.get_dataloader">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dataloader</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;inference&#39;</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
        <span class="n">shuffle</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">remove_invalid</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">store_dim</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preset_transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">calculate_stats</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">mean</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">),</span>
        <span class="n">std</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">),</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">image_set</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">target_transform</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">resize</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">normalize_to</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Retrieve the PyTorch dataloader (torch.utils.data.DataLoader) for this dataset.</span>
<span class="sd">            </span>
<span class="sd">        :param mode: The mode of training to select. See available modes with `available_modes`.</span>
<span class="sd">        :type mode: str</span>
<span class="sd">        :param batch_size: The batch size of the image. Default: 16.</span>
<span class="sd">        :type batch_size: int</span>
<span class="sd">        :param shuffle: Whether to shuffle the data before loading. Default: `True`.</span>
<span class="sd">        :type shuffle: bool</span>
<span class="sd">        :param num_workers: Number of workers for the dataloader. Default: 0.</span>
<span class="sd">        :type num_workers: int</span>
<span class="sd">        :param remove_invalid: If set to True, deletes any NaN/corrupt items in the image set</span>
<span class="sd">            pertaining to the relevant mode. In the False case, either NaN values are substituted</span>
<span class="sd">            with empty values or an error is thrown, depending on the mode selected.</span>
<span class="sd">        :type remove_invalid: bool</span>
<span class="sd">        :param store_dim: If set to True, the labels in the dataset will return a dict with two</span>
<span class="sd">            keys. `label` contains the standard PyTorch labels and `dim` contains the image&#39;s</span>
<span class="sd">            former dimensions.</span>
<span class="sd">        :type store_dim: bool</span>
<span class="sd">        :param preset_transform: Whether to use default preset transforms. Consists of normalization</span>
<span class="sd">            with either calculated mean of the dataset about to be used or standard ImageNet</span>
<span class="sd">            statistics depending on `calculate_stats`. Default: `True`</span>
<span class="sd">        :type preset_transform: bool</span>
<span class="sd">        :param calculate_stats: Whether to calculate mean and std for this dataset to be used in</span>
<span class="sd">            normalization transforms. If False, uses ImageNet default weights. Only has effect</span>
<span class="sd">            when `preset_transform` is set to `True`. Default: `True`</span>
<span class="sd">        :type calculate_stats: bool</span>
<span class="sd">        :param mean: Default mean statistics for the dataset. Has no effect when</span>
<span class="sd">            `calculate_stats = True`. Default: ImageNet values.</span>
<span class="sd">        :type mean: Tuple[float, ...]</span>
<span class="sd">        :param std: Default mean statistics for the dataset. Has no effect when</span>
<span class="sd">            `calculate_stats = True`. Default: ImageNet values.</span>
<span class="sd">        :type std: Tuple[float, ...]</span>
<span class="sd">        :param normalize: When set to True, normalize the dataset according to some mean/std values,</span>
<span class="sd">            either from calculated stats or ImageNet default. This statement is overriden when</span>
<span class="sd">            `calculate_stats` is set to T`rue. Default: `True`.</span>
<span class="sd">        :type normalize: bool</span>
<span class="sd">        :param image_set: The image set to pull from. Default: all images.</span>
<span class="sd">        :type image_set: Optional[str]</span>
<span class="sd">        :param transform: The transform operation to apply to the images.</span>
<span class="sd">        :type transform: Optional[Callable]</span>
<span class="sd">        :param target_transform: The transform operation to apply to the labels.</span>
<span class="sd">        :type target_transform: Optional[Callable]</span>
<span class="sd">        :param transforms: Tuple in the format `(transform, target_transform)`. Obtain default</span>
<span class="sd">            transforms from `DynamicData.get_transforms()`, or supply your own.</span>
<span class="sd">        :type transforms: Optional[Tuple[Optional[Callable], ...]]</span>
<span class="sd">        :param resize: If provided, resize all images to exact `(width, height)` configuration.</span>
<span class="sd">        :type resize: Optional[Tuple[int, ...]]</span>
<span class="sd">        :param normalize_to: If provided, normalize bounding box/segmentation coordinates to a</span>
<span class="sd">            specific configuration. Options: &#39;zeroone&#39;, &#39;full&#39;</span>
<span class="sd">        :type normalize_to: Optional[str]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_dataset</span><span class="p">(</span>
                <span class="n">mode</span><span class="p">,</span>
                <span class="n">remove_invalid</span><span class="o">=</span><span class="n">remove_invalid</span><span class="p">,</span>
                <span class="n">store_dim</span><span class="o">=</span><span class="n">store_dim</span><span class="p">,</span>
                <span class="n">image_set</span><span class="o">=</span><span class="n">image_set</span><span class="p">,</span>
                <span class="n">preset_transform</span><span class="o">=</span><span class="n">preset_transform</span><span class="p">,</span>
                <span class="n">calculate_stats</span><span class="o">=</span><span class="n">calculate_stats</span><span class="p">,</span>
                <span class="n">mean</span><span class="o">=</span><span class="n">mean</span><span class="p">,</span>
                <span class="n">std</span><span class="o">=</span><span class="n">std</span><span class="p">,</span>
                <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span>
                <span class="n">target_transform</span><span class="o">=</span><span class="n">target_transform</span><span class="p">,</span>
                <span class="n">transforms</span><span class="o">=</span><span class="n">transforms</span><span class="p">,</span>
                <span class="n">resize</span><span class="o">=</span><span class="n">resize</span><span class="p">,</span>
                <span class="n">normalize_to</span><span class="o">=</span><span class="n">normalize_to</span><span class="p">),</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="n">shuffle</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">_collate</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">store_dim</span><span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="DynamicData.split_image_set">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.split_image_set">[docs]</a>
    <span class="k">def</span> <span class="nf">split_image_set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image_set</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="o">*</span><span class="n">new_sets</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
        <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Split the existing image set into new image sets. If inplace is True, the existing image</span>
<span class="sd">        set will receive the percentage that is missing from the rest of the sets, or deleted if</span>
<span class="sd">        the other sets add up to 1.</span>
<span class="sd">        </span>
<span class="sd">        :param image_set: The old image set name to split. Accepts both name and ID.</span>
<span class="sd">        :type image_set: str | int</span>
<span class="sd">        :param new_sets: Each entry of `new_sets` has a name for the set accompanied with a float to</span>
<span class="sd">            represent the percentage to split data into.</span>
<span class="sd">        :type new_sets: Tuple[str, float]</span>
<span class="sd">        :param inplace: Whether to perform the operation inplace on the existing image set. If</span>
<span class="sd">            `False`, then the new sets are required to add up to exactly 100% of the compositions.</span>
<span class="sd">            If `True`, any remaining percentages less than 100% will be filled back into the old</span>
<span class="sd">            image set. Default: `False`.</span>
<span class="sd">        :type inplace: bool</span>
<span class="sd">        :param seed: The seed to use for the operation, in case consistent dataset manipulation</span>
<span class="sd">            in memory is required. Default: `None`</span>
<span class="sd">        :type seed: Optional[int]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># checks before splitting</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;id&#39;</span>
        <span class="n">check_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span>
        <span class="k">if</span> <span class="n">image_set</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">check_set</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;image_set_missing&#39;</span><span class="p">,</span> <span class="n">imgset_name</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="n">image_set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">new_set</span> <span class="ow">in</span> <span class="n">new_sets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">check_set</span><span class="p">:</span>
                <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;new_exists&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">imgset_name</span><span class="o">=</span><span class="n">new_set</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">tot_frac</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">new_set</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">new_set</span> <span class="ow">in</span> <span class="n">new_sets</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inplace</span> <span class="ow">and</span> <span class="n">tot_frac</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;split_invalid&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;not equal to&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inplace</span> <span class="ow">and</span> <span class="n">tot_frac</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;split_invalid&#39;</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;greater than&#39;</span><span class="p">)</span>

        <span class="c1"># assemble new sets</span>
        <span class="n">new_sets</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">new_sets</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="n">new_sets</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image_set</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tot_frac</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="c1"># add to existing image set tracker</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_sets</span><span class="p">:</span>
                <span class="n">next_id</span> <span class="o">=</span> <span class="n">next_avail_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="p">[</span><span class="n">next_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">next_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">new_sets</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># assign image sets</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">image_set</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_NAME&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">partition</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
            <span class="n">running_sum</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">next_set</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_sets</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">running_sum</span> <span class="o">&lt;=</span> <span class="n">partition</span> <span class="o">&lt;=</span> <span class="n">running_sum</span> <span class="o">+</span> <span class="n">next_set</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">next_id</span> <span class="o">=</span> <span class="n">next_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">[</span><span class="n">next_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="n">next_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">next_set</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span> <span class="k">else</span> <span class="n">next_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">image_set</span><span class="p">)</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_NAME&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_name</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_ID&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_id</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_name</span><span class="p">)</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_id</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">running_sum</span> <span class="o">+=</span> <span class="n">next_set</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_image_sets</span><span class="p">(</span><span class="n">image_set</span><span class="p">)</span></div>


<div class="viewcode-block" id="DynamicData.get_image_set">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.get_image_set">[docs]</a>
    <span class="k">def</span> <span class="nf">get_image_set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image_set</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Retrieve the sub-DataFrame which contains all images in a specific image set.</span>

<span class="sd">        :param image_set: The image set. Accepts both string and int.</span>
<span class="sd">        :type image_set: str | int</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">image_set</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">image_set</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)]</span></div>


<div class="viewcode-block" id="DynamicData.clear_image_sets">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.clear_image_sets">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_image_sets</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Clear image sets from the dict if they contain no elements.</span>

<span class="sd">        :param sets: If defined, only scan the provided list, otherwise scan all sets.</span>
<span class="sd">            Default: `None`.</span>
<span class="sd">        :type sets: list[str | int], Optional</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">to_pop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">sets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span>
        <span class="k">for</span> <span class="n">image_set</span> <span class="ow">in</span> <span class="n">sets</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_set</span><span class="p">(</span><span class="n">image_set</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">to_pop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">image_set</span> <span class="ow">in</span> <span class="n">to_pop</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">image_set</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="DynamicData.delete_image_set">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.delete_image_set">[docs]</a>
    <span class="k">def</span> <span class="nf">delete_image_set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">image_set</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Delete image set from all entries. If an entry has only that image set, replace with the</span>
<span class="sd">        default dataset.</span>

<span class="sd">        :param image_set: The image set to delete. Accepts both name and ID.</span>
<span class="sd">        :type image_set: str | int</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">using_id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_set</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">using_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image_set</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="p">:</span>
                <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;image_set_missing&#39;</span><span class="p">,</span> <span class="n">imgset_name</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="n">image_set</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">image_set</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">image_set</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">:</span>
                <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;image_set_missing&#39;</span><span class="p">,</span> <span class="n">imgset_name</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">image_set</span><span class="o">=</span><span class="n">image_set</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">image_set</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;default&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">:</span>
            <span class="n">default_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_idx</span> <span class="o">=</span> <span class="n">next_avail_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_ID&#39;</span><span class="p">]:</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_ID&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">default_idx</span><span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="s1">&#39;IMAGE_SET_NAME&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">and</span> <span class="s1">&#39;default&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_idx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="p">[</span><span class="n">default_idx</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_image_sets</span><span class="p">()</span></div>


<div class="viewcode-block" id="DynamicData.save">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.save">[docs]</a>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">safe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Save the dataset into DynamicData json format.</span>

<span class="sd">        :param filename: The filename to save the dataset.</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param overwrite: Whether to overwrite the file if it already exists. Default: `False`.</span>
<span class="sd">        :type overwrite: bool</span>
<span class="sd">        :param safe: If `True`, do not encode `form` with jsonpickle. Then dataset cannot be</span>
<span class="sd">            re-parsed, but is no longer subject to arbitrary code injection upon load.</span>
<span class="sd">        :type safe: bool</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">safe</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unsafe_save&#39;</span><span class="p">)</span>
        <span class="n">this</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;root&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span>
            <span class="s1">&#39;safe&#39;</span><span class="p">:</span> <span class="n">safe</span><span class="p">,</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">safe</span> <span class="k">else</span> <span class="n">jsonpickle</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s1">&#39;dataframe&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span>
            <span class="s1">&#39;image_set_to_idx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_set_to_idx</span><span class="p">,</span>
            <span class="s1">&#39;idx_to_image_set&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_image_set</span><span class="p">,</span>
            <span class="s1">&#39;class_to_idx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_to_idx</span><span class="p">,</span>
            <span class="s1">&#39;idx_to_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_class</span><span class="p">,</span>
            <span class="s1">&#39;seg_class_to_idx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_class_to_idx</span><span class="p">,</span>
            <span class="s1">&#39;idx_to_seg_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_seg_class</span><span class="p">,</span>
            <span class="s1">&#39;bbox_class_to_idx&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_class_to_idx</span><span class="p">,</span>
            <span class="s1">&#39;idx_to_bbox_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx_to_bbox_class</span><span class="p">,</span>
            <span class="s1">&#39;get_md5_hashes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_md5_hashes</span><span class="p">,</span>
            <span class="s1">&#39;bbox_scale_option&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_scale_option</span><span class="p">,</span>
            <span class="s1">&#39;seg_scale_option&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_scale_option</span><span class="p">,</span>
            <span class="s1">&#39;available_modes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span><span class="p">,</span>
            <span class="s1">&#39;cleaned&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;file_exists&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">this</span><span class="p">))</span></div>


<div class="viewcode-block" id="DynamicData.load">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.load">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Load a DynamicData object from file. Warning: do not load any json files that you did not</span>
<span class="sd">        create. This method uses jsonpickle, an insecure loading system with potential for arbitrary</span>
<span class="sd">        Python code execution.</span>

<span class="sd">        :param filename: The filename to load the data from.</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Loading dataset...&#39;</span><span class="p">)</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;safe&#39;</span><span class="p">]:</span>
                <span class="n">Warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unsafe_load&#39;</span><span class="p">)</span>
            <span class="n">this</span><span class="p">:</span> <span class="n">DynamicData</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">],</span>
                <span class="n">jsonpickle</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">],</span> <span class="n">keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;safe&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">get_md5_hashes</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;get_md5_hashes&#39;</span><span class="p">],</span>
                <span class="n">bbox_scale_option</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;bbox_scale_option&#39;</span><span class="p">],</span>
                <span class="n">seg_scale_option</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;seg_scale_option&#39;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">this</span><span class="o">.</span><span class="n">dataframe</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;dataframe&#39;</span><span class="p">]))</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;image_set&#39;</span><span class="p">,</span> <span class="s1">&#39;class&#39;</span><span class="p">,</span> <span class="s1">&#39;bbox_class&#39;</span><span class="p">,</span> <span class="s1">&#39;seg_class&#39;</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span>
                    <span class="n">this</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_to_idx&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_to_idx&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span>
                    <span class="n">this</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;idx_to_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;idx_to_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="p">)</span>
            <span class="n">this</span><span class="o">.</span><span class="n">available_modes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;available_modes&#39;</span><span class="p">]</span>
            <span class="n">this</span><span class="o">.</span><span class="n">cleaned</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;cleaned&#39;</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DynamicData] Loaded dataset! (</span><span class="si">{</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">}</span><span class="s1">s)&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The following error occurred: </span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;invalid_dataset&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">this</span></div>


<div class="viewcode-block" id="DynamicData.sample_image">
<a class="viewcode-back" href="../../dynamicdl.html#dynamicdl.dynamicdl.DynamicData.sample_image">[docs]</a>
    <span class="k">def</span> <span class="nf">sample_image</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">dpi</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1200</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Sample an image from the dataset.</span>

<span class="sd">        :param dpi: The image display size, if not in segmentation mode.</span>
<span class="sd">        :type dpi: float</span>
<span class="sd">        :param mode: Pick from any of the available modes, or supply a list of modes. Default:</span>
<span class="sd">            all modes.</span>
<span class="sd">        :type mode: Optional[str | list[str]]</span>
<span class="sd">        :param idx: Use a specific idx from the dataset. Default: a random image.</span>
<span class="sd">        :type idx: Optional[int]</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">union</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">try_mode</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">try_mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span><span class="p">:</span>
                    <span class="n">Warnings</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;mode_unavailable&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">try_mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_modes</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
            <span class="n">T</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
            <span class="n">T</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">open_image</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;ABSOLUTE_FILE&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;classification&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[DynamicData] Image Class ID/Name: </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;CLASS_ID&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;CLASS_NAME&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;detection&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;BOX&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">draw_bounding_boxes</span><span class="p">(</span>
                    <span class="n">image</span><span class="p">,</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">box</span><span class="p">)</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;BOX&#39;</span><span class="p">]]),</span>
                    <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">labels</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;BBOX_CLASS_NAME&#39;</span><span class="p">],</span>
                    <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[DynamicData] Warning: Image has no bounding boxes.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;segmentation_mask&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">open_image</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;ABSOLUTE_FILE_SEG&#39;</span><span class="p">]))</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;segmentation_poly&#39;</span> <span class="ow">in</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;POLYGON&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;SEG_CLASS_ID&#39;</span><span class="p">]),</span> \
                <span class="s1">&#39;SEG_CLASS_ID and POLYGON len mismatch&#39;</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;ABSOLUTE_FILE&#39;</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">next_avail_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idx_to_seg_class</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">class_id</span><span class="p">,</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;SEG_CLASS_ID&#39;</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;POLYGON&#39;</span><span class="p">]):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">fillPoly</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">pts</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">polygon</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)],</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">class_id</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">axarr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Anthony Tong.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>